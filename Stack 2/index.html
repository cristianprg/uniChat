<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>UniChat — WebSocket</title>
    <style>
      :root {
        --bg: #0f1724;
        --card: #0b1220;
        --accent: #6ee7b7;
        --muted: #9aa6b2;
        --bubble-self: #16a34a;
        --bubble-other: #2563eb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Arial;
        background: linear-gradient(180deg, #07142a, #07162f);
        color: #e6eef6;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .app {
        width: 100%;
        max-width: 960px;
        margin: 10px;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
        display: grid;
        grid-template-columns: 280px 1fr;
        background: var(--card);
        min-height: 520px;
      }
      .left {
        padding: 16px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .logo {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--accent), #34d399);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #052023;
        margin-bottom: 6px;
      }
      h1 {
        margin: 0;
        font-size: 18px;
      }
      .small {
        font-size: 13px;
        color: var(--muted);
      }
      input,
      button {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: transparent;
        color: inherit;
        font-size: 14px;
      }
      button {
        cursor: pointer;
        font-weight: 600;
        background: linear-gradient(90deg, var(--accent), #34d399);
        color: #052023;
        border: none;
      }
      .status {
        font-size: 13px;
        color: var(--muted);
      }
      .users {
        font-size: 13px;
        margin-top: auto;
      }
      .users ul {
        margin: 6px 0;
        padding-left: 16px;
      }
      .right {
        display: flex;
        flex-direction: column;
      }
      .chat-header {
        padding: 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .messages {
        flex: 1;
        overflow: auto;
        padding: 14px;
        background: radial-gradient(
          ellipse at top left,
          rgba(255, 255, 255, 0.02),
          transparent 25%
        );
      }
      .message {
        max-width: 75%;
        margin: 6px 0;
        padding: 10px 12px;
        border-radius: 14px;
        line-height: 1.3;
        word-wrap: break-word;
      }
      .self {
        margin-left: auto;
        background: var(--bubble-self);
        color: #fff;
        border-radius: 14px 14px 4px 14px;
      }
      .other {
        margin-right: auto;
        background: var(--bubble-other);
        color: #fff;
        border-radius: 14px 14px 14px 4px;
      }
      .meta {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .system {
        text-align: center;
        font-size: 13px;
        color: var(--muted);
        margin: 10px 0;
      }
      .composer {
        display: flex;
        gap: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px;
      }
      textarea {
        flex: 1;
        resize: none;
        min-height: 44px;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: transparent;
        color: inherit;
        font-size: 14px;
      }
      @media (max-width: 800px) {
        .app {
          grid-template-columns: 1fr;
        }
        .messages {
          max-height: calc(100vh - 160px);
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="left">
        <div class="logo">UC</div>
        <h1>UniChat</h1>
        <div class="small">Messenger con WebSockets</div>
        <input id="username" placeholder="Tu nombre..." />
        <button id="connectBtn">Conectar</button>
        <div class="status" id="status">No conectado</div>
        <div class="users" id="usersPanel" hidden>
          <b>Usuarios conectados</b>
          <ul id="usersList"></ul>
        </div>
      </aside>
      <main class="right">
        <div class="chat-header">Sala Pública</div>
        <div id="messages" class="messages"></div>
        <div class="composer">
          <textarea
            id="input"
            placeholder="Escribe un mensaje... (Enter para enviar)"
          ></textarea>
          <button id="sendBtn">Enviar</button>
        </div>
      </main>
    </div>
    <script>
      (() => {
        const SERVER_IP = window.location.hostname;
        let ws = null,
          username = "",
          connected = false;
        const status = document.getElementById("status");
        const usersPanel = document.getElementById("usersPanel");
        const usersList = document.getElementById("usersList");
        const messages = document.getElementById("messages");
        const input = document.getElementById("input");
        const connectBtn = document.getElementById("connectBtn");
        const sendBtn = document.getElementById("sendBtn");
        let users = new Set();

        function addSystem(text) {
          const d = document.createElement("div");
          d.className = "system";
          d.textContent = text;
          messages.appendChild(d);
          messages.scrollTop = messages.scrollHeight;
        }
        function addMessage(user, text) {
          const d = document.createElement("div");
          d.className = "message " + (user === username ? "self" : "other");
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = user;
          d.appendChild(meta);
          d.appendChild(document.createTextNode(text));
          messages.appendChild(d);
          messages.scrollTop = messages.scrollHeight;
        }
        function updateUsers() {
          usersList.innerHTML = "";
          if (users.size) {
            usersPanel.hidden = false;
          } else {
            usersPanel.hidden = true;
          }
          [...users].sort().forEach((u) => {
            const li = document.createElement("li");
            li.textContent = u;
            usersList.appendChild(li);
          });
        }
        function connect() {
          username = document.getElementById("username").value.trim();
          if (!username) {
            alert("Debes escribir un nombre");
            return;
          }
          ws = new WebSocket(`ws://${SERVER_IP}:8765`);
          ws.onopen = () => {
            connected = true;
            status.textContent = "Conectado";
            ws.send(JSON.stringify({ type: "join", username }));
            addSystem("Conectado al servidor");
          };
          ws.onmessage = (ev) => {
            const msg = JSON.parse(ev.data);
            if (msg.type === "message") {
              addMessage(msg.username, msg.text);
            } else if (msg.type === "system") {
              addSystem(msg.text);
              if (msg.subtype === "join") {
                users.add(msg.username);
                updateUsers();
              }
              if (msg.subtype === "leave") {
                users.delete(msg.username);
                updateUsers();
              }
            }
          };
          ws.onclose = () => {
            status.textContent = "No conectado";
            users.clear();
            updateUsers();
            connected = false;
            addSystem("Desconectado");
          };
        }
        function send() {
          if (!connected) {
            addSystem("No estás conectado");
            return;
          }
          const text = input.value.trim();
          if (!text) return;
          ws.send(JSON.stringify({ type: "message", username, text }));
          input.value = "";
        }
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            send();
          }
        });
        sendBtn.onclick = send;
        connectBtn.onclick = connect;
      })();
    </script>
  </body>
</html>
